\RequirePackage{tikz}
\RequirePackage{etoolbox}
\makeatletter
\def\tikz@splitNameAndShape#1,#2\tikz@stop{%
  \def\tikzNodeName{#1}%
  \def\tikzNodeShape{#2}%
}

\newif\if@TikzNodeRecord@

\patchcmd\tikz@node@finish
  {\endgroup\endgroup}
  {%
    \iftikz@node@is@a@label\else
      \if@TikzNodeRecord@
        \xappto\tikzNodeList{,{\tikz@last@fig@name,\tikz@shape}}%
        % \PackageWarning{tikz}{\tikzNodeList}%
      \fi
    \fi
    \endgroup\endgroup
  }
  {}{\fail}

\tikzset{
  every picture/.append style={
    execute at begin picture={%
      \xdef\tikzNodeList{}%
      \@TikzNodeRecord@true
    },
    execute at end picture={
      \@TikzNodeRecord@false
      % \PackageWarning{tikz}{end: \tikzNodeList}%
      \let\tikzNodeList@const=\tikzNodeList
      \foreach \i in \tikzNodeList@const {
        \ifx\i\@empty
        \else
          \expandafter\tikz@splitNameAndShape\i\tikz@stop
          \ifx\tikzNodeName\@empty\else
            \node also[pin={[every auto mark/.try, every auto \tikzNodeShape\space mark/.try]{\tikzAutoMarkText}}] (\tikzNodeName);
          \fi
        \fi
      }
    }
  },
  every auto mark/.style={
    font=\ttfamily,
    rotate=45,
    red,
    anchor=west,
    pin position=45,
  },
  every auto coordinate mark/.style={
    blue,
    anchor=east,
    pin position=180+45,
  },
}

\newcommand\tikzAutoMarkText{\tikzNodeName}
\makeatother
